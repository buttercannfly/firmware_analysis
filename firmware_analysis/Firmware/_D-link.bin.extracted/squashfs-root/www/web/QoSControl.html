<!DOCTYPE html>
<html id="html">
<head>
<meta name="viewport" content="width=1200">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="Pragma" content="No-cache" />
<meta http-equiv="Cache-Control" content="no-cache, must-revalidate" />
<meta http-equiv="Expires" content="-1" />
<link rel=stylesheet type="text/css" href="css/jquery.selectbox.css" media="all" />
<link href="css/stylish-select.css" type="text/css" rel="stylesheet" />
<link href="css/style_page.css" type="text/css" rel="stylesheet" />
<style>
#slideshow	{	margin: 0 0 0 0;	}
/* ---------------- Item Instance ---------------- */
#itemInstance {
	width:  188px;
	height: 86px;
	background-image: url('image/qos_itemBg.png');
	z-index: 10;
}
.dataElement {
	position: relative;
	background-image: url('image/qos_itemBg.png');
}
.dataElement_deviceName {
	position: absolute;
	top: 18px;
	left: 20px;
	color: #333333;
	font-size: 14px;
	width: 140px;
	overflow: hidden;
	text-align:left;
}

.dataElement_vendor {
	position: absolute;
	text-transform:uppercase;
	top: 38px;
	left: 0px;
	color: #888;
	width: 140px;
	overflow: hidden;
	font-size: 12px;
}
.dataElement_ip {
	position: absolute;
	top: 55px;
	left: 20px;
	color: #666666;
	width: 140px;
	overflow: hidden;
	font-size: 12px;
	text-align:left;
}
.dataElement_mac {
	position: absolute;
	display: none;
	top: 55px;
	left: 0px;
	color: #666;
	width: 140px;
	overflow: hidden;
	font-size: 12px;
}
.dataElement_deviceNameReal {
	position: absolute;
	display: none;
	top: 55px;
	left: 30px;
	color: #666;
	width: 140px;
	overflow: hidden;
	font-size: 12px;
}
.qos_label {
	font-size: 16px;
	color: #888;
	text-align: center;
	width:900px;
	float:left;
}
#qos_label_alldevices {
	margin-top:18px;
	margin-bottom:8px;
}
#qos_label_priority {
	margin: 25px 0 20px 0;
	font-size: 12px;
}
/* ---------------- prioity ---------------- */
#prioity {
	width:  825px;
	height: 400px;
	margin: 0 auto;
}
/* ---------------- prioity : highest ---------------- */
#prioity_highest {
	position: relative;
	float:left;
	margin: 0 2px;
	width:  200px;
	height: 116px;
	vertical-align: top;
}
#prioity_highest_bg {
	position: absolute;
	width:  100%;
	height: 100%;
	top:0;
	left:0;
	background-image: url('image/qos_priority_highest.gif');
}
#prioity_high_bg {
	position: absolute;
	width:  100%;
	height: 100%;
	top:0;
	left:0;
	background-image: url('image/qos_priority_high.gif');
}
#prioity_medium_bg {
	position: absolute;
	width:  100%;
	height: 100%;
	top:0;
	left:0;
	background-image: url('image/qos_priority_medium.gif');
}
#prioity_highest_label, #prioity_high_label, #prioity_medium_label {
	position: absolute;
	top:4px;
	left: 0;
	text-align:center;
	width: 100%;
	color: #fff;
	font-size: 14px;
}
#prioity_highest_container, #prioity_high_container, #prioity_medium_container{
	position: relative;
	top: 22px;
	left: 6px;
}
#prioity_highest_hitarea {
	position: absolute;
	top: 0;
	left: 0;
	width:  200px;
	height: 116px;
	background-color: blue;
	z-index: 500;
	opacity: 0;
	filter: alpha(opacity=0); 
}
/* ---------------- prioity : high ---------------- */
#prioity_high {
	position: relative;
	float:left;
	margin: 0 2px;
	width:  200px;
	height: 202px;
	vertical-align: top;
}
#prioity_high_hitarea {
	position: absolute;
	top: 0;
	left: 0;
	width:  200px;
	height: 202px;
	background-color: blue;
	z-index: 500;
	opacity: 0;
	filter: alpha(opacity=0); 
}
/* ---------------- prioity : medium ---------------- */
#prioity_medium {
	position: relative;
	float:left;
	margin: 0 2px;
	width:  388px;
	height: 374px;
	vertical-align: top;
}
#prioity_medium_hitarea {
	position: absolute;
	top: 0;
	left: 0;
	width:  388px;
	height: 374px;
	background-color: blue;
	z-index: 500;
	opacity: 0;
	filter: alpha(opacity=0); 
}
</style>
<title></title>
<script type="text/javascript" charset="utf-8" src="js/localization/zh-cn.js?V=dir822"></script>
<script type="text/javascript" charset="utf-8" src="js/header.js"></script>
<script type="text/javascript" charset="utf-8" src="js/jquery-1.8.2.min.js"></script>
<script type="text/javascript" charset="utf-8" src="js/jquery.selectbox-0.2_new.js"></script>
<script type="text/javascript" charset="utf-8" src="js/SOAP/SOAPAction.js"></script>
<script type="text/javascript" charset="utf-8" src="js/initialJS.js"></script>
<script type="text/javascript" charset="utf-8" src="js/verify/verify.js"></script>
<script type="text/javascript" charset="utf-8" src="js/GridPanel.js"></script>
<script type="text/javascript" charset="utf-8" src="js/Slideshow.js"></script>
<script type="text/javascript">
//xframeoption
if(top!=self){top.location=self.location;}

var DebugMode=0;
var HNAP = new HNAP_XML();
var Qos_enable="";
var Qos_upSpeed="";
var Qos_downSpeed="";
var Qos_mode="";
var speed_type="";
var Qos_type="";
var G_Device_list=[];
var G_Qos_Highest_Rule=[];
var G_Medium_Rule=[];
var G_Low_Rule=[];
var B_G_Qos_Highest_Rule="";
var B_G_Medium_Rule="";
var B_G_Low_Rule="";
var speedtest_bw_upstream="50";
var speedtest_bw_downstream="50";
$(document).ready( function() {
	document.getElementById("content").style.display="none";
	document.getElementById("CreateOnloadMessage").style.display="";
	basiccontainerminiheigh();
	GetXML();
	checkTimeout();
	
	document.getElementById("btn_auto_speed").value = I18N("j","QoS_Auto_SpeedTest");//重新测速
	document.getElementById("btn_manual_speed").value = I18N("j","QoS_Manual_Speed_Test");//手工修改
	document.getElementById("btn_modify_cancel").value = I18N("j","Commom_Cancel");//取消
	document.getElementById("btn_modify_confirm").value = I18N("j","Commom_Apply");//确定
	document.getElementById("btn_fail_confirm").value = I18N("j","Commom_Confirm");//确认
	document.getElementById("btn_zero_confirm").value = I18N("j","Commom_Confirm");//确认

	document.getElementById("btn_speedtest_calcel").value = I18N("j","Commom_Cancel");//取消
	document.getElementById("btn_speedtest_apply").value = I18N("j","Commom_Apply");//确定
	
});

function GetXML()
{
	var result_xml = new StringDoc();
	if (result_xml != null)
	{
		result_xml.Set("GetMultipleHNAPs/GetSmartQoSSettings");
		result_xml.Set("GetMultipleHNAPs/GetStationSettings");
		HNAP.SetXMLAsync("GetMultipleHNAPs", result_xml, function(xml){  GetQoSInfoResult_2nd(xml);});
	} 
	else
	{	
		if (DebugMode == 1)	
		{	
			alert("[!!GetSmartQoSInfoXML Error!!] Function: GetSmartQoSInfoXML");	
		}	
	}
}

function GetQoSInfoResult_2nd(result_xml)
{
	var GetQoSInfoResult_2nd = result_xml.Get("GetMultipleHNAPsResponse/GetSmartQoSSettingsResponse/GetSmartQoSSettingsResult");
	if (GetQoSInfoResult_2nd == "OK")
	{
		
		var wire_sta_list = result_xml.Get("GetMultipleHNAPsResponse/GetStationSettingsResponse/wire_sta_list");
		var wireless_sta_2g_list= result_xml.Get("GetMultipleHNAPsResponse/GetStationSettingsResponse/wireless_sta_2g_list");
		var wireless_sta_5g_list= result_xml.Get("GetMultipleHNAPsResponse/GetStationSettingsResponse/wireless_sta_5g_list");
		var wireless_sta_5g_guest_list= result_xml.Get("GetMultipleHNAPsResponse/GetStationSettingsResponse/wireless_sta_5g_guest_list");
		var wireless_sta_2g_guest_list= result_xml.Get("GetMultipleHNAPsResponse/GetStationSettingsResponse/wireless_sta_2g_guest_list");
		var offline_sta_list= result_xml.Get("GetMultipleHNAPsResponse/GetStationSettingsResponse/offline_sta_list");
		
		Qos_type = result_xml.Get("GetMultipleHNAPsResponse/GetSmartQoSSettingsResponse/smartqos_type");
		Qos_mode= result_xml.Get("GetMultipleHNAPsResponse/GetSmartQoSSettingsResponse/smartqos_mode");
		Qos_enable = result_xml.Get("GetMultipleHNAPsResponse/GetSmartQoSSettingsResponse/smartqos_enable");
		Qos_upSpeed = toDecimal(result_xml.Get("GetMultipleHNAPsResponse/GetSmartQoSSettingsResponse/smartqos_upstream_shapingrate"));//转成Mb/s
		Qos_downSpeed = toDecimal(result_xml.Get("GetMultipleHNAPsResponse/GetSmartQoSSettingsResponse/smartqos_downstream_shapingrate"));//转成Mb/s
		var Qos_Highest_Rule=result_xml.Get("GetMultipleHNAPsResponse/GetSmartQoSSettingsResponse/smartqos_priority_devices");
		var Medium_Rule=result_xml.Get("GetMultipleHNAPsResponse/GetSmartQoSSettingsResponse/smartqos_express_devices");
		var Low_Rule=result_xml.Get("GetMultipleHNAPsResponse/GetSmartQoSSettingsResponse/smartqos_normal_devices");

		 B_G_Qos_Highest_Rule=Qos_Highest_Rule;
		 B_G_Medium_Rule=Medium_Rule;
		 B_G_Low_Rule=Low_Rule;
		
		var wirelisttem=[];
		if(wire_sta_list!="")
		{
			wirelisttem=wire_sta_list.split(";");
		}
		
		var total=0;
		for(var i=0;i<wirelisttem.length;i++)
		{
			G_Device_list.push(wirelisttem[i].split(","));	
		}
		
		
		var wlan2glisttem=[];
		if(wireless_sta_2g_list!="")
		{
			wlan2glisttem=wireless_sta_2g_list.split(";");
		}
		

		for(var i=0;i<wlan2glisttem.length;i++)
		{
			G_Device_list.push(wlan2glisttem[i].split(","));	
		}
		
		var wlan5glisttem=[];
		if(wireless_sta_5g_list!="")
		{
			wlan5glisttem=wireless_sta_5g_list.split(";");
		}
		

		for(var i=0;i<wlan5glisttem.length;i++)
		{
			G_Device_list.push(wlan5glisttem[i].split(","));	
		}
		
		var wireless_sta_2g_guest_list_tem=[];
		 if(wireless_sta_2g_guest_list!="")
		  {
			wireless_sta_2g_guest_list_tem=wireless_sta_2g_guest_list.split(";");
		  }
		 for(var i=0;i<wireless_sta_2g_guest_list_tem.length;i++)
		 {
			G_Device_list.push(wireless_sta_2g_guest_list_tem[i].split(","));	
		 }
		 
		 var wireless_sta_5g_guest_listtem=[];
		  if(wireless_sta_5g_guest_list!="")
		  {
			wireless_sta_5g_guest_listtem=wireless_sta_5g_guest_list.split(";");
		  }
		 for(var i=0;i<wireless_sta_5g_guest_listtem.length;i++)
		 {
			G_Device_list.push(wireless_sta_5g_guest_listtem[i].split(","));	
		 }
		
		var offlinelisttem=[];
		if(offline_sta_list!="")
		{
			offlinelisttem=offline_sta_list.split(";");
		}
		
		var offlinelist=[];

		for(var i=0;i<offlinelisttem.length;i++)
		{
			offlinelist.push(offlinelisttem[i].split(","));

		}		
			
		var G_Qos_Highest_Rule_Tem=[];
		var G_Medium_Rule_Tem=[];
		var G_Low_Rule_Tem=[];
		
		if(Qos_Highest_Rule!="")
		G_Qos_Highest_Rule_Tem=Qos_Highest_Rule.split(",");
		if(Medium_Rule!="")
		G_Medium_Rule_Tem=Medium_Rule.split(",");
		if(Low_Rule!="")
		G_Low_Rule_Tem=Low_Rule.split(",");
		
		
		for(var j=0;j<G_Qos_Highest_Rule_Tem.length;j++)
		{
			var h=0;
			G_Qos_Highest_Rule[j]=[];
			for(var k=0;k<G_Device_list.length;k++)
			{
				if((G_Qos_Highest_Rule_Tem[j].toLowerCase())==(G_Device_list[k][0].toLowerCase()))
				{
					G_Qos_Highest_Rule[j].push(G_Device_list[k][0]);
					G_Qos_Highest_Rule[j].push(G_Device_list[k][1]);
					G_Qos_Highest_Rule[j].push(G_Device_list[k][2]);
					addDevice(G_Device_list[k][2],G_Device_list[k][1],"highest",G_Device_list[k][0]); //name,ip,priority,mac
					G_Device_list.splice(k, 1);
					 h=1;
					 break;
				}
			  
			}
			
			if(h==0)
			{
				for(var q=0;q<offlinelist.length;q++)
				{
					if((G_Qos_Highest_Rule_Tem[j].toLowerCase())==(offlinelist[q][0].toLowerCase()))
					{
						G_Qos_Highest_Rule[j].push(offlinelist[q][0]);
						G_Qos_Highest_Rule[j].push(offlinelist[q][1]);
						G_Qos_Highest_Rule[j].push(offlinelist[q][2]);
						addDevice(offlinelist[k][2],offlinelist[k][1],"highest",offlinelist[k][0]);
						 h=1;
						 break;
					}
				
				}
				
			}
			
			if(h==0)
			{
				G_Qos_Highest_Rule[j].push(G_Qos_Highest_Rule_Tem[j]);
				G_Qos_Highest_Rule[j].push(G_Qos_Highest_Rule_Tem[j]);
				G_Qos_Highest_Rule[j].push(G_Qos_Highest_Rule_Tem[j]);
				addDevice(G_Qos_Highest_Rule_Tem[j],"Unknown","highest",G_Qos_Highest_Rule_Tem[j]);
			
			}
			
			
		}

		for(var j=0;j<G_Medium_Rule_Tem.length;j++)
		{
			var m=0;
			G_Medium_Rule[j]=[];
			for(var k=0;k<G_Device_list.length;k++)
			{
				if((G_Medium_Rule_Tem[j].toLowerCase())== (G_Device_list[k][0].toLowerCase()))
				{
					G_Medium_Rule[j].push(G_Device_list[k][0]);
					G_Medium_Rule[j].push(G_Device_list[k][1]);
					G_Medium_Rule[j].push(G_Device_list[k][2]);
					addDevice(G_Device_list[k][2],G_Device_list[k][1],"high",G_Device_list[k][0]); //name,ip,priority,mac
					G_Device_list.splice(k, 1);
					 m=1;
					 break;
				}
			  
			}
			

			if(m==0)
			{
				for(var q=0;q<offlinelist.length;q++)
				{
					if((G_Medium_Rule_Tem[j].toLowerCase())==(offlinelist[q][0].toLowerCase()))
					{
						G_Medium_Rule[j].push(offlinelist[q][0]);
						G_Medium_Rule[j].push(offlinelist[q][1]);
						G_Medium_Rule[j].push(offlinelist[q][2]);
						addDevice(offlinelist[k][2],offlinelist[k][1],"high",offlinelist[k][0]);
						 m=1;
						 break;
					}
				
				}
				
			}
			
			
			if(m==0)
			{
				G_Medium_Rule[j].push(G_Medium_Rule_Tem[j]);
				G_Medium_Rule[j].push(G_Medium_Rule_Tem[j]);
				G_Medium_Rule[j].push(G_Medium_Rule_Tem[j]);
				addDevice(G_Medium_Rule_Tem[j],"Unknown","high",G_Medium_Rule_Tem[j]);
			}
		}
		
		
		for(var j=0;j<G_Low_Rule_Tem.length;j++)
		{
			var l=0;
			G_Low_Rule[j]=[];
			for(var k=0;k<G_Device_list.length;k++)
			{
				if((G_Low_Rule_Tem[j].toLowerCase())==(G_Device_list[k][0].toLowerCase()))
				{
					G_Low_Rule[j].push(G_Device_list[k][0]);
					G_Low_Rule[j].push(G_Device_list[k][1]);
					G_Low_Rule[j].push(G_Device_list[k][2]);
					addDevice(G_Device_list[k][2],G_Device_list[k][1],"medium",G_Device_list[k][0]); //name,ip,priority,mac
					G_Device_list.splice(k, 1);
					 l=1;
					 break;
				}
			  
			}
			
			if(l==0)
			{
				for(var q=0;q<offlinelist.length;q++)
				{
					if((G_Low_Rule_Tem[j].toLowerCase())==(offlinelist[q][0].toLowerCase()))
					{
						G_Low_Rule[j].push(offlinelist[q][0]);
						G_Low_Rule[j].push(offlinelist[q][1]);
						G_Low_Rule[j].push(offlinelist[q][2]);
						addDevice(offlinelist[k][2],offlinelist[k][1],"medium",offlinelist[k][0]);
						 l=1;
						 break;
					}
				
				}
				
			}
			
			
			if(l==0)
			{
				G_Low_Rule[j].push(G_Low_Rule_Tem[j]);
				G_Low_Rule[j].push(G_Low_Rule_Tem[j]);
				G_Low_Rule[j].push(G_Low_Rule_Tem[j]);
				addDevice(G_Low_Rule_Tem[j],"Unknown","medium",G_Low_Rule_Tem[j]);
			}
		}
		
		for(var d=0;d<G_Device_list.length;d++)
		{
			addDevice(G_Device_list[d][2],G_Device_list[d][1],"none",G_Device_list[d][0]);
		}		
		
		
		if("1"==Qos_enable)
		{
			//显示所有元素
			document.getElementById("Qos_statue").className = "checkbox_on";
			document.getElementById("Qos_checkEnable").checked=true;
			document.getElementById("QoSContent").style.display = "";
			//显示速度
			document.getElementById("upspeed_display").innerHTML=Qos_upSpeed;
			document.getElementById("downspeed_display").innerHTML=Qos_downSpeed;

		}
		else if("0"==Qos_enable)
		{
			document.getElementById("Qos_statue").className = "checkbox_off";
			document.getElementById("Qos_checkEnable").checked=false;
			document.getElementById("QoSContent").style.display ="none";
		}
		
			document.getElementById("content").style.display="";
			document.getElementById("CreateOnloadMessage").style.display="none";			
		
	} 
	else 
	{	
		document.getElementById("content").style.display="";
		document.getElementById("CreateOnloadMessage").style.display="none";			
		if (DebugMode == 1)
		{	
			alert("[!!GetXML Error!!] Function: GetResult_2nd");
		}
	}
}

function SaveData(tag)
{
		$.ajax({
			cache: false,
			url: "./js/CheckConnection",
			timeout: 5000,
			type: "GET",
			success: function(data) {
				SetXML(tag);
			},
			error: function() {
				document.getElementById("DetectRouterConnection").style.display = "inline";
			}
		});	
}
	
function SetXML(tag) {
	document.getElementById("CreatePopAlertMessage").style.display = "inline";
	document.getElementById("waitSettingFinish").style.display = "inline";
	SetResult_1st(tag);
}
function SetResult_1st(tag) {
	var result_xml = new StringDoc();
	if (result_xml != null) 
	{		
		if(document.getElementById("Qos_checkEnable").checked==true){Qos_enable="1";}
		else{Qos_enable="0";}
		result_xml.Set("SetSmartQoSSettings/smartqos_enable", Qos_enable);
		result_xml.Set("SetSmartQoSSettings/smartqos_upstream_shapingrate", (Qos_upSpeed*1024).toString());
		result_xml.Set("SetSmartQoSSettings/smartqos_downstream_shapingrate", (Qos_downSpeed*1024).toString());
		result_xml.Set("SetSmartQoSSettings/smartqos_type", "by_device");
		if(tag==1)
		{
			var counter = 0;
			var highrule="";
			var mediumrule="";
			var lowrule="";
			for(var i = 1; i <= deviceDataArray.length; i ++)
			{
				switch (deviceDataArray[counter].priority)
				{	
	
					case "highest":	highrule+=deviceDataArray[counter].mac+",";	break;				
					case "high":	mediumrule+=deviceDataArray[counter].mac+",";	break;						
					case "medium":	lowrule+=deviceDataArray[counter].mac+",";	break;		
				}
				counter ++;
			}
			if(highrule.length>0)
			{
				highrule=highrule.substring(0,highrule.length-1);
			}
			if(mediumrule.length>0)
			{
				mediumrule=mediumrule.substring(0,mediumrule.length-1);
			}
			if(lowrule.length>0)
			{
				lowrule=lowrule.substring(0,lowrule.length-1);
			}
			result_xml.Set("SetSmartQoSSettings/smartqos_priority_devices", highrule);
			result_xml.Set("SetSmartQoSSettings/smartqos_express_devices", mediumrule);
			result_xml.Set("SetSmartQoSSettings/smartqos_normal_devices", lowrule);
		}
		
		else
		{
				result_xml.Set("SetSmartQoSSettings/smartqos_priority_devices", B_G_Qos_Highest_Rule);
				result_xml.Set("SetSmartQoSSettings/smartqos_express_devices", B_G_Medium_Rule);
				result_xml.Set("SetSmartQoSSettings/smartqos_normal_devices", B_G_Low_Rule);
		}

		HNAP.SetXMLAsync("SetSmartQoSSettings", result_xml, function(xml)	{	SetResult_2nd(xml);	});
	}
	else 
	{	
		if (DebugMode == 1)
		{	
			alert("[!!SetXML Error!!] Function: SetResult_1st");	
		}	
	}
}

function SetResult_2nd(result_xml) 
{
	var SetResult_1st = result_xml.Get("SetSmartQoSSettingsResponse/SetSmartQoSSettingsResult");
	if (SetResult_1st == "OK") 
	{
		setTimeout("waitSettingFinished()", 1000);
	}
	else 
	{
		if (DebugMode == 1)
		{	
			alert("[!!SetXML Error!!] Function: SetResult_2nd");
			window.location.reload();
		}
	}
	
}
function waitSettingFinished() 
{
	window.location.reload();
}

function hideAllErrorInfo()
{
	document.getElementById("error_1").style.display = "none"; 
	document.getElementById("error_2").style.display = "none"; 
}
function verifySpeedInput()
{
	hideAllErrorInfo();
	var upspeedValue=$("#upSpeed_Manual").val();
	var downspeedValue=$("#downSpeed_Manual").val();

	var resultup=verifyQosInput(upspeedValue,0.01,100);
	switch(resultup)
	{
		case ERR_INPUT_EMPTY:
			showErr("error_1","errorinfo_1",I18N("j","Err_QoScontrol_UpSpeedEmpty"));
			return false;
		case ERR_INPUT_INVALID:
			showErr("error_1","errorinfo_1",I18N("j","Err_QoScontrol_UpSpeedSpace"));
			return false;
		case ERR_QoS_FIRSTZERO:
			showErr("error_1","errorinfo_1",I18N("j","Err_QoScontrol_UpSpeedFirstZero"));
			return false;
		case ERR_QoS_FORMAT:
			showErr("error_1","errorinfo_1",I18N("j","Err_QoScontrol_UpSpeedFormat"));
			return false;
		case ERR_QoS_OUTSMALL:
			showErr("error_1","errorinfo_1",I18N("j","Err_QoScontrol_UpSpeedSmallRange"));
			return false;
		case ERR_QoS_OUTLARGE:
			showErr("error_1","errorinfo_1",I18N("j","Err_QoScontrol_UpSpeedLargeRange"));
			return false;
		default:
			break;
	}
	
	var resultdown=verifyQosInput(downspeedValue,0.01,100);
	switch(resultdown)
	{
		case ERR_INPUT_EMPTY:
			showErr("error_2","errorinfo_2",I18N("j","Err_QoScontrol_DownSpeedEmpty"));
			return false;
		case ERR_INPUT_INVALID:
			showErr("error_2","errorinfo_2",I18N("j","Err_QoScontrol_DownSpeedSpace"));
			return false;
		case ERR_QoS_FIRSTZERO:
			showErr("error_2","errorinfo_2",I18N("j","Err_QoScontrol_DownSpeedFirstZero"));
			return false;
		case ERR_QoS_FORMAT:
			showErr("error_2","errorinfo_2",I18N("j","Err_QoScontrol_DownSpeedFormat"));
			return false;
		case ERR_QoS_OUTSMALL:
			showErr("error_2","errorinfo_2",I18N("j","Err_QoScontrol_DownSpeedSmallRange"));
			return false;
		case ERR_QoS_OUTLARGE:
			showErr("error_2","errorinfo_2",I18N("j","Err_QoScontrol_DownSpeedLargeRange"));
			return false;
		default:
			break;
	}
	return true;
}

function checkQosModeType()//获取智能Qos的点击模式
{
	var type=Qos_mode;
	for(var i=0;i<4;i++)
	{
		var checkboxQosId="checkboxQoS"+i;
		if(document.getElementById(checkboxQosId).checked==true)
		{
			if(0==i){type="auto";}
			else if(1==i){type="video";}
			else if(2==i){type="game";}
			else{type="web";}
		}
	}
	return type;
}

function GetConnectionXML()
{
	var result_xml = new StringDoc();
	if (result_xml != null)
	{
		//result_xml.Set("GetNetworkConnectStatus");
		result_xml.Set("GetMultipleHNAPs/GetSysStatus");
		result_xml.Set("GetMultipleHNAPs/GetConnectStatusRealtime");
		HNAP.SetXMLAsync("GetMultipleHNAPs", result_xml, function(xml)
		{  
			GetConnectionResult_2nd(xml);
		});
	} 
	else
	{	
		if (DebugMode == 1)	
		{	
			alert("[!!GetConnectionXML Error!!] Function: GetConnectionXML");	
		}	
	}
}

function GetConnectionResult_2nd(result_xml)
{
	var GetConnectionResult_2nd = result_xml.Get("GetMultipleHNAPsResponse/GetMultipleHNAPsResult");
	if (GetConnectionResult_2nd == "OK")
	{
		var isConnected = result_xml.Get("GetMultipleHNAPsResponse/GetConnectStatusRealtimeResponse/wan_connect_status");
		var wanip = result_xml.Get("GetMultipleHNAPsResponse/GetSysStatusResponse/wan_wan(0)_ipaddr");
		if(isConnected==0 || ""==wanip)
		{
			document.getElementById("CreatePopAlertMessage2").style.display = "inline";
			document.getElementById("SpeedTestRunning").style.display = "none";
			document.getElementById("SpeedTestFailed").style.display = "block";
			//alert(document.getElementById("SpeedTestFailed").offsetHeight);
		}
		else
		{
			var result_xml = new StringDoc();
			if (result_xml != null) {
				document.getElementById("CreatePopAlertMessage2").style.display = "inline";
				document.getElementById("SpeedTestRunning").style.display = "block";
				document.getElementById("SpeedTestFailed").style.display = "none";
				result_xml.Set("SpeedTest");
				HNAP.SetXMLAsync("SpeedTest", result_xml, function(xml)
				{	
					var speedTestResult=xml.Get("SpeedTestResponse/SpeedTestResult");
					if(speedTestResult == "OK" )
					{
						speedtest_bw_upstream=xml.Get("SpeedTestResponse/speedtest_bw_upstream");//转成Mb/s
						speedtest_bw_downstream=xml.Get("SpeedTestResponse/speedtest_bw_downstream");//转成Mb/s
						//Qos_upSpeed=speedtest_bw_upstream;
						//Qos_downSpeed=speedtest_bw_downstream;
						//SetResult_1st();
						if("0"==speedtest_bw_upstream || "0"==speedtest_bw_downstream)
						{
							document.getElementById("SpeedTestRunning").style.display = "none";
							document.getElementById("SpeedTestFailedZero").style.display = "block";
							return false;
						}
						else
						{
							document.getElementById("upspeed_display_pop").innerHTML = toDecimal(speedtest_bw_upstream);
							document.getElementById("downspeed_display_pop").innerHTML = toDecimal(speedtest_bw_downstream);
							document.getElementById("CreatePopAlertMessage2").style.display="none";//正在测速窗口
							document.getElementById("createPop_SpeedTest_Result").style.display="";//测速完成的提示窗口
						}
					}	
				});
			}
		}
	} 
	else 
	{	
		if (DebugMode == 1)
		{	
			alert("[!!GetXML Error!!] Function: GetConnectionResult_2nd");
		}
	}
}

//测速完成之后弹窗点击确定
function SpeedTestPopConfirm()
{
	$.ajax({
		cache: false,
		url: "./js/CheckConnection",
		timeout: 5000,
		type: "GET",
		success: function(data) {
			document.getElementById("createPop_SpeedTest_Result").style.display="none";
			document.getElementById("CreatePopAlertMessage").style.display = "inline";
			document.getElementById("waitSettingFinish").style.display = "inline";
			SetAutoSpeedResult_1st(speedtest_bw_upstream,speedtest_bw_downstream);
		},
		error: function() {
			document.getElementById("DetectRouterConnection").style.display = "inline";
		}
	});
}

//测速完成之后弹窗点击取消
function SpeedTestPopCancel()
{
	document.getElementById("createPop_SpeedTest_Result").style.display="none";
}

function SetAutoSpeedResult_1st(upspeed,downspeed)
{
	var result_xml = new StringDoc();
	if (result_xml != null) 
	{		
		if(document.getElementById("Qos_checkEnable").checked==true){Qos_enable="1";}
		else{Qos_enable="0";}
		//Qos_mode=checkQosModeType();
		result_xml.Set("SetSmartQoSSettings/smartqos_enable", Qos_enable);
		result_xml.Set("SetSmartQoSSettings/smartqos_upstream_shapingrate", upspeed);
		result_xml.Set("SetSmartQoSSettings/smartqos_downstream_shapingrate", downspeed);
		result_xml.Set("SetSmartQoSSettings/smartqos_type", "by_device");
		result_xml.Set("SetSmartQoSSettings/smartqos_priority_devices", B_G_Qos_Highest_Rule);
		result_xml.Set("SetSmartQoSSettings/smartqos_express_devices", B_G_Medium_Rule);
		result_xml.Set("SetSmartQoSSettings/smartqos_normal_devices", B_G_Low_Rule);
		//result_xml.Set("SetSmartQoSSettings/smartqos_mode", Qos_mode);
		HNAP.SetXMLAsync("SetSmartQoSSettings", result_xml, function(xml)	{	SetResult_2nd(xml);	});
	}
	else 
	{	
		if (DebugMode == 1)
		{	
			alert("[!!SetXML Error!!] Function: SetAutoSpeedResult_1st");
		}	
	}
}

function autoSpeedTest()//重新测速
{
	//speed_type="autospeed";
	GetConnectionXML();
}

function SpeedTestFailed()
{
	document.getElementById("CreatePopAlertMessage2").style.display = "none";
	document.getElementById("SpeedTestRunning").style.display = "none";
	document.getElementById("SpeedTestFailed").style.display = "none";
	document.getElementById("SpeedTestFailedZero").style.display = "none";
	//window.location.href = "QoSControl.html";
}

function manualSpeedTest()//点击手动测试时弹出框
{
	document.getElementById("createPop").style.display = "";
	document.getElementById("upSpeed_Manual").value=Qos_upSpeed;
	document.getElementById("downSpeed_Manual").value=Qos_downSpeed;
}

function modifyCancle()
{
	hideAllErrorInfo();
	document.getElementById("createPop").style.display = "none";
	document.getElementById("upSpeed_Manual").value="";
	document.getElementById("downSpeed_Manual").value="";
	/*
	document.getElementById("upspeed_display").innerHTML=upSpeed_dis;
	document.getElementById("downspeed_display").innerHTML=downSpeed_dis;
	*/
}

function modifyConfirm()//手动修改点击确定
{
	var result =verifySpeedInput();
	if(result)
	{
		
		Qos_upSpeed=parseFloat(document.getElementById("upSpeed_Manual").value);//手工修改的值
		Qos_downSpeed=parseFloat(document.getElementById("downSpeed_Manual").value);
		
		document.getElementById("upspeed_display").innerHTML=Qos_upSpeed;
		document.getElementById("downspeed_display").innerHTML=Qos_downSpeed;

		document.getElementById("upSpeed_Manual").value="";
		document.getElementById("downSpeed_Manual").value="";
		document.getElementById("createPop").style.display = "none";
		SaveData(0);
	}
}

function QosTypeChange(num,type)
{
	for(var i=0;i<4;i++)
	{
		var QoS_SelectId="QoS_Select"+i;
		var checkboxQoSId="checkboxQoS"+i;
		var discription="description"+i;
		if(i==num)
		{	
			document.getElementById(checkboxQoSId).checked=true;
			document.getElementById(QoS_SelectId).className="QoS_check";
			document.getElementById(discription).style.display = "";
		}
		else
		{
			document.getElementById(checkboxQoSId).checked=false;
			document.getElementById(QoS_SelectId).className="QoS_original";
			document.getElementById(discription).style.display = "none";
		}
	}
	SaveData(1);
}

function SaveDataDevice()
{
	SaveData(1);

}

function ChangQosStatus()//点击开启按键
{
	
	var a = document.getElementById("Qos_checkEnable").checked;
		
	if(a)
	{
		
		document.getElementById("Qos_statue").className = "checkbox_off";
		document.getElementById("Qos_checkEnable").checked=false;
		document.getElementById("QoSContent").style.display = "none";
	}
	else
	{
		
		document.getElementById("Qos_statue").className = "checkbox_on";
		document.getElementById("Qos_checkEnable").checked=true;
		document.getElementById("QoSContent").style.display = "";
	}
	SaveData(0);
}
function toDecimal(num)//将Kb/s转成Mb/s，四舍五入，保留两位小数
{
	var float_num = parseFloat(num)/1024;
	return Math.round(float_num*100)/100;
}




</script>
</head>
<body data-spy="scroll" data-target=".bs-docs-sidebar">
<!-------------------- Logo menu------------------------->
<div class="wrapper"> 
	<div id="header"></div>
	<div class="clearboth" align="center" id="content" style="display:none; ">
		<div class="basiccontainer" align="center" id="basiccontent">

		  	<table border="0" cellpadding="0" cellspacing="0" class="clearboth" align="left">
				<tr>
					<td align="left">		 
					<div class="clearboth headerline" align="left"><script>I18N("h","Commom_QoS_Control");</script><!-- 智能流控 --> </div>
		            </td>
					<td style="vertical-align:bottom; " class="tdcheckbox">		
						<div id="Qos_statue" class="checkbox_off" onclick="ChangQosStatus()">
							<input type="checkbox" id="Qos_checkEnable" name="Qos_checkEnable">
						</div>
					</td>
					</tr>
			</table> 

			<div class="line clearboth"></div>
			<div class="description clearboth"><script>I18N("h","QoS_Description");</script></div>
 			<div id="QoSContent" style="display:none; padding-top:64px;"> 
				 <div class="clearboth headerline2" align="left"><script>I18N("h","QoS_Network_Status");</script><!-- 外网带宽状态 --></div>
				<div class="line"></div>
				
				<table class="tableqos clearboth" style="margin-top:36px" align="left">
					<tr>
						<td align="left" colspan="2">
							<span><script>I18N("h","QoS_Up_Speed");</script><!-- 上传速率 --></span>
							<span id="upspeed_display" style="padding-left:24px; font-size:24px; font-weight:bold;color:#4598aa; "></span>
							<span style="color:#4598aa;">Mb/s</span>
							<span style="padding-left:128px; "><script>I18N("h","QoS_Down_Speed");</script><!-- 下载速率 --></span>
							<span id="downspeed_display" style="padding-left:24px; font-size:24px; font-weight:bold; color:#4598aa;"></span>
							<span style="color:#4598aa;">Mb/s</span>						
						</td>
					</tr>
					<tr>
						<td colspan="2" class="tdbutton">
							<!-- <span><input type="button" class="styled_button_ss" value="重新测速" onclick="autoSpeedTest()"></span><span style="padding-left:24px; "><input type="button" class="styled_button_ss" value="手工修改" onclick="manualSpeedTest()" ></span> -->
							<span><input type="button" class="styled_button_ss" id="btn_auto_speed" value="" onclick="autoSpeedTest()"></span><span style="padding-left:24px; "><input type="button" class="styled_button_ss" id="btn_manual_speed" value="" onclick="manualSpeedTest()" ></span>
						</td>
					</tr>
				</table>
				 <div class="clearboth headerline2" align="left" style="padding-top:64px; ">
				 <div style="float:left; "><script>I18N("h","QoS_Smart_Distribution");</script></div><div style="float:right; "><input type="button" class="styled_button_mdium" id="btn_qos_by_device" value="保存" onclick="SaveDataDevice()"></div>
				 </div>
				<div class="line clearboth"></div>
				<div id="main">
				<div id="qos_label_alldevices" class="qos_label" style="width:900px; float:left; " >已连接客户端</div>
				<div id="slideshow" class="clearboth"></div>
				<div id="qos_label_priority" class="qos_label clearboth">将设备卡拖至以下优先级框</div>
				<div class="clearboth"> </div>				
				<div id="prioity" style="clear:both; float:left;margin-left:35px; ">
					<div id="prioity_highest">
						<div id="prioity_highest_bg"></div>
						<div id="prioity_highest_label">最高</div>
						<div id="prioity_highest_container"></div>
						<div id="prioity_highest_hitarea" style="display:none;cursor:pointer;" onmouseover="setDraggingTargetPriority('highest')" onmouseout="setDraggingTargetPriority('none')"></div>
					</div>
					<div id="prioity_high">
						<div id="prioity_high_bg"></div>
						<div id="prioity_highest_label">高</div>
						<div id="prioity_high_container"></div>
						<div id="prioity_high_hitarea" style="display:none;cursor:pointer;" onmouseover="setDraggingTargetPriority('high')" onmouseout="setDraggingTargetPriority('none')"></div>
					</div>
					<div id="prioity_medium">
						<div id="prioity_medium_bg"></div>
						<div id="prioity_medium_label">中</div>
						<div id="prioity_medium_container"></div>
						<div id="prioity_medium_hitarea" style="display:none;cursor:pointer;" onmouseover="setDraggingTargetPriority('medium')" onmouseout="setDraggingTargetPriority('none')"></div>
					</div>
				</div>
			</div>
				
				
				
				<div class="clearboth"> </div>
			</div>
	</div>
	</div>
	
	<div style=" display:none;" id="createPop">
	  <div style="width:500px;top:50%; margin-top:-172px;" class="dialogBox2">
		<div class="advance_row"><span ><script>I18N("h","QoS_Set_Speed_Value");</script><!-- 手工设置外网带宽 --></span></div>
		<div class="moredescription" style="margin-left:9px;text-align:justify;"><span><script>I18N("h","QoS_Network_ManualInput_Tips");</script><!-- 温馨提示：若填写的带宽低于实际值，则最大网速会受到限制；若高于实际值，则QoS智能分配规则可能无法生效。如不清楚实际带宽值，请联系宽带运营商。 --></span></div>
		<table cellspacing="0" border="0" id="tblWlanAccess" class="block" style="width:428px;margin:0 auto; margin-top:32px; ">
		  <tbody>
			<tr>
			  <th><script>I18N("h","QoS_DialogBox_Up");</script><!-- 上传（Mb/s） --></th>
			  <td>
				<input type="text" maxlength="6" id="upSpeed_Manual" size="32" name="upSpeed_Manual" class="styled-text">
			  </td>
			</tr>
			<tr id="error_1" style="display:none; ">
			  	<td>&nbsp;</td>
			  	<td class="errorinfo">
					<table>
						<tbody>
							<tr>
								<td><div class="ic-sign ic"></div></td>
								<td id="errorinfo_1" style="line-height:20px;"></td>
							</tr>
						</tbody>
					</table>
				</td>
			</tr>			
			<tr class="space"></tr>			
			<tr>
			  <th><script>I18N("h","QoS_DialogBox_Down");</script><!-- 下载（Mb/s） --></th>
			  <td>
				<input type="text" maxlength="6" id="downSpeed_Manual" size="32" name="downSpeed_Manual" class="styled-text">
			  </td>
			</tr>			
			<tr id="error_2" style="display:none; ">
			  	<td>&nbsp;</td>
			  	<td class="errorinfo">
					<table>
						<tbody>
							<tr>
								<td><div class="ic-sign ic"></div></td>
								<td id="errorinfo_2" style="line-height:20px;"></td>
							</tr>
						</tbody>
					</table>
				</td>
			 </tr>			
			<tr class="space"></tr>
			</tbody>
		</table>
		<div align="center" style="margin-top:32px; ">
			<!-- <span><input type="button" value="取消" class="styled_button_ss" onClick="modifyCancle();"></span> -->
			<span><input type="button" id="btn_modify_cancel" value="" class="styled_button_ss" onClick="modifyCancle();"></span>
			<span style="margin-left:20px; ">
				<!-- <input type="button" value="确定" class="styled_button_ss" onClick="modifyConfirm();"> -->
				<input type="button" id="btn_modify_confirm" value="" class="styled_button_ss" onClick="modifyConfirm();">
			</span>
		</div>
	  </div>
	</div>	
 <div class="footer_placeholder"></div> 
 
 <div id="CreatePopAlertMessage2" style="display:none;">
	<div id="SpeedTestFailed" style="display:none;width:656px;top:50%; margin-top:-145px;padding-left:0px;padding-right:0px;" class="dialogBox2" align="center">
		<div>
			<img src="image/icon_peizhi_sb-.png" class="Backup_img">
			<div class="words" style="margin-bottom:34px;margin-top:26px"><script>I18N("h","QoS_Auto_Speed_Fail");</script><!-- 自动测速失败，请检查网络设置！ --></div>
		</div>
		<div class="advance_rowBackup" style="padding-bottom:0px;margin:0"></div>
		<div align="center" style="margin-top:26px;">
			<!-- <input type="button" value="确认" style="width:280px" class="styled_button_ss" onClick="SpeedTestFailed();"> -->
			<input type="button" id="btn_fail_confirm" value="" style="width:280px" class="styled_button_ss" onClick="SpeedTestFailed();">
		</div>
	</div>
	<div id="SpeedTestFailedZero" style="display:none;width:656px;top:50%; margin-top:-145px;padding-left:0px;padding-right:0px" class="dialogBox2" align="center">
		<div>
			<img src="image/icon_peizhi_sb-.png" class="Backup_img">
			<div class="words" style="margin-bottom:34px;margin-top:26px"><script>I18N("h","QoS_Auto_Speed_Zero");</script><!-- 外网带宽速率为0，请检查外网连通性后重试！ --></div>
		</div>
		<div class="advance_rowBackup" style="padding-bottom:0px;margin:0"></div>
		<div align="center" style="margin-top:26px;">
			<!-- <input type="button" value="确认" style="width:280px" class="styled_button_ss" onClick="SpeedTestFailed();"> -->
			<input type="button" id="btn_zero_confirm" value="" style="width:280px" class="styled_button_ss" onClick="SpeedTestFailed();">
		</div>
	</div>
	<div id="SpeedTestRunning" style="display:none;width:656px;top:50%; margin-top:-196px;padding-top:21px;" class="dialogBox2" align="center">
		<div class="advance_rowBackup" style="font-size:20px;padding-bottom:21px;margin:0px;">
			<span><script>I18N("h","QoS_Network_Speed");</script><!-- 网络测速 --></span>
		</div>
		<div style="margin-top:38px;" align="center">
			<img src="image/icon_speed.png" style="width:124px;height:86px"/>
			<div class="words" style="color:#333333;margin-top:14px;">
				正在进行宽带测速，整个过程大约需要20秒
			</div>
			<div class="words" style="color:#333333;margin-bottom:16px;margin-top:8px;">
				<script>I18N("h","QoS_Auto_Speed_Testing");</script><!-- 正在测速，请稍等...... -->
			</div>
			<img src="image/progress-bar.gif" style="width:318px;height:8px;margin-bottom:54px;"/>
		</div>
	</div>
</div>
	<div style="display:none;" id="createPop_SpeedTest_Result" class="createPopRecovery">
		<div class="dialogBoxBackup" style="height:auto;top:50%;margin-top:-183px;">
			<div class="advance_rowBackup" style="font-size:20px;padding-bottom:21px;margin:0px;">
				<span><script>I18N("h","QoS_Auto_SpeedTest_Result");</script><!-- 测速结果 --></span>
			</div>
			<div class="tableqos" style="text-align:center;margin:50px 0;">
				<span><script>I18N("h","QoS_Up_Speed");</script><!-- 上传速率 --></span>
				<span id="upspeed_display_pop" style="padding-left:24px;font-size:24px;font-weight:bold;color:#3a4046;">50</span>
				<span>Mb/s</span>
				<span style="padding-left:50px;"><script>I18N("h","QoS_Down_Speed");</script><!-- 下载速率 --></span>
				<span id="downspeed_display_pop" style="padding-left:24px;font-size:24px;font-weight:bold;color:#3a4046;">50</span>
				<span>Mb/s</span>
			</div>
			<div style="color:#82878d;font-size:14px;"><script>I18N("h","QoS_Auto_SpeedTest_Result_Apply");</script><!-- 是否将当前测速结果应用于QoS智能分配功能？ --></div>
			<div class="advance_rowBackup" style="margin:0px"></div>
			<div align="center" style="margin-bottom:48px;margin-top:24px">
				<input type="button" id="btn_speedtest_calcel" value="取消" class="styled_button_ss" style="margin-left:45px;" onClick="SpeedTestPopCancel();">
				<input type="button" id="btn_speedtest_apply" value="确定" class="styled_button_ss" style="margin-left:18px;margin-right:45px;" onClick="SpeedTestPopConfirm();">
			</div>
		</div>
	</div>
</div>	
	<div id="footer"></div>
	<div id="CreatePopAlertMessage" style=" display:none;"></div>
	<div style=" display:none;" id="DetectRouterConnection"></div>
	<div id="CreateOnloadMessage" style="display:none;"><div class="OnLoadPopRect"><img src="/image/submit.gif" width="58" height="58"></div></div>
	
	<div id="itemInstance" style="position:absolute; top:0; left:0; display:none;cursor:pointer;">
		<div class="data">
			<div class="dataElement_deviceName" id="itemInstance_deviceName"></div>
			<div class="dataElement_vendor" id="itemInstance_vendor"></div>
			<div class="dataElement_ip" id="itemInstance_ip"></div>
			<div class="dataElement_mac" id="itemInstance_mac"></div>
			<div class="dataElement_deviceNameReal" id="itemInstance_deviceNameReal"></div>
		</div>
	</div>
</body>
<script type="text/javascript">
Initial();
var mousex 				= 0;
var mousey 				= 0;
var itemMouseOffsetX 	= 0;
var itemMouseOffsetY 	= 0;
var instance 			= document.getElementById("itemInstance");
var isDraggingItem 		= false;
var dragginItemData		= null;
var targetPriority		= "";
//--------------------------------------------------------------
//		DeviceData
//--------------------------------------------------------------
var deviceData = function(deviceName, ip, priority, mac) {

	this.deviceName 	= deviceName;
	//this.vendor			= vendor;
	this.ip				= ip;
	this.mac			= mac
	this.priority 		= priority;
	//this.deviceNameReal	= deviceNameReal;
	this.element;
	
	//--------------------------------------------------------------
	// create element
	this.element 						= document.createElement("div");
	this.element.style.width 			= "188px";
	this.element.style.height 			= "86px";
	this.element.style.fontSize			= "12px";
	this.element.style.cursor			= "pointer";
	this.element.style.verticalAlign	= "top";
	this.element.style.margin			= "0 6px";
	this.element.className				= "dataElement";
	this.element.onmouseover = function() {
		this.style.backgroundPosition = "bottom left";
	};
	this.element.onmouseout = function() {
		this.style.backgroundPosition = "top left";
	};
	
	// DeviceName
	this.element_deviceName 			= document.createElement("div");
	this.element_deviceName.className	= "dataElement_deviceName";
	this.element_deviceName.innerHTML 	= deviceName;
	
	// Vendor
	//this.element_vendor 				= document.createElement("div");
	//this.element_vendor.className		= "dataElement_vendor";
	//this.element_vendor.innerHTML 		= vendor;
	
	// IP
	this.element_ip 					= document.createElement("div");
	this.element_ip.className			= "dataElement_ip";
	this.element_ip.innerHTML 			= ip;
	
	// MAC
	this.element_mac 					= document.createElement("div");
	this.element_mac.className			= "dataElement_mac";
	this.element_mac.innerHTML 			= mac;
	
	// deviceNameReal
	//this.element_deviceNameReal 				= document.createElement("div");
	//this.element_deviceNameReal.className		= "dataElement_deviceNameReal";
	//this.element_deviceNameReal.innerHTML 		= deviceNameReal;
	
	this.element.appendChild(this.element_deviceName);
	//this.element.appendChild(this.element_vendor);
	this.element.appendChild(this.element_ip);
	this.element.appendChild(this.element_mac);
	//this.element.appendChild(this.element_deviceNameReal);
	
	// preset priority status
	if (priority != "none") {
		this.element.style.width 	= "0px";
		this.element.style.opacity 	= "0";
		this.element.style.filter = "alpha(opacity=0)"; //for IE8
		this.element.style.margin	= "0";

		//for IE8
		this.element_deviceName.style.display 	= "none";
		//this.element_vendor.style.display 	= "none";
		this.element_ip.style.display 	= "none";
	}
	
	var data = this;
	//--------------------------------------------------------------
	// set priority
	this.setPriority = function(value) {
		data.priority = value;
	}
	//--------------------------------------------------------------
	// Events
	// mouse
	this.element.onmousedown = function() {
		if	(data.priority == "none") {
		
			$(this.element).stop(); // prevent double click error (hide animation is playing)
			
			// get element position
			var itemPos = getElementXY(this);
			
			// count mouse offset
			itemMouseOffsetX = itemPos.x - mousex;
			itemMouseOffsetY = itemPos.y - mousey;
			
			// pass value to instance
			document.getElementById("itemInstance_deviceName").innerHTML		= data.deviceName;
			//document.getElementById("itemInstance_vendor").innerHTML			= data.vendor;
			document.getElementById("itemInstance_ip").innerHTML				= data.ip;
			document.getElementById("itemInstance_mac").innerHTML				= data.mac; 
			//document.getElementById("itemInstance_deviceNameReal").innerHTML	= data.deviceNameReal;
			
			// hide this
			data.hideElement_noAnimation();
			
			// show instance
			instance.style.top  	= itemPos.y + "px";
			instance.style.left 	= itemPos.x + "px";
			instance.style.display 	= "block";
			
			// isDragging
			startDrag(data);
		}
	}

	if ( this.element.addEventListener ) {
		this.element.addEventListener("touchstart", function(e) {
			
			if	(data.priority == "none") {
			
				$(this.element).stop(); // prevent double click error (hide animation is playing)
				
				// get element position
				var itemPos = getElementXY(this);
				
				// count mouse offset
				itemMouseOffsetX = itemPos.x - e.changedTouches[0].pageX; // Touch position!!
				itemMouseOffsetY = itemPos.y - e.changedTouches[0].pageY; // Touch position!!
				
				// pass value to instance
				document.getElementById("itemInstance_deviceName").innerHTML		= data.deviceName;
				//document.getElementById("itemInstance_vendor").innerHTML			= data.vendor;
				document.getElementById("itemInstance_ip").innerHTML				= data.ip;
				document.getElementById("itemInstance_mac").innerHTML				= data.mac; 
				//document.getElementById("itemInstance_deviceNameReal").innerHTML	= data.deviceNameReal;
				
				// hide this
				data.hideElement_noAnimation();
				
				// show instance
				instance.style.top  	= itemPos.y + "px";
				instance.style.left 	= itemPos.x + "px";
				instance.style.display 	= "block";
				
				// isDragging
				startDrag(data);
			}
		});
	}
	//--------------------------------------------------------------
	// show
	this.showElement_backToSlideshow = function() {
		mySlideshow.putAndSlideToLast(data.element, function() {
			$(data.element).stop();
			$(data.element).animate({opacity:1, width:"188px"}, 300, 'easeOutCubic');
			data.element.style.cursor					= "pointer";
			data.element.style.margin					= "0 6px";
			data.element_deviceName.style.display		= "block";
			//data.element_vendor.style.display			= "block";
			data.element_ip.style.display				= "block"; 
			data.element_mac.style.display				= "none";
			//data.element_deviceNameReal.style.display	= "none";
		});
	}
	this.showElement_noAnimation = function() {
		data.element.style.width					= "188px";
		$(data.element).css({ opacity: 1 });        // for IE8
		data.element.style.opacity					= 1
		data.element.style.margin 					= "0 6px";
		data.element.style.cursor  					= "pointer";
		data.element_deviceName.style.display 		= "block";
		//data.element_vendor.style.display 			= "block";
		data.element_ip.style.display 				= "block";
		data.element_mac.style.display 				= "none";
		//data.element_deviceNameReal.style.display	= "none";
	}
	//--------------------------------------------------------------
	// hide
	this.hideElement = function() {
		$(data.element).stop();
		$(data.element).animate({width:"0px", margin:"0px"}, 300, 'easeOutCubic');
		data.element.style.cursor  = "default";
		data.element_deviceName.style.display 		= "none";
		//data.element_vendor.style.display 			= "none";
		data.element_ip.style.display 				= "none";
		data.element_mac.style.display 				= "none"; 
		//data.element_deviceNameReal.style.display	= "none";
		mySlideshow.updateToLastPage();
	}
	this.hideElement_noAnimation = function() {
		data.element.style.opacity = "0";
		$(data.element).css({ opacity: 0 }); //for IE8
		data.element_deviceName.style.display 		= "none";
		//data.element_vendor.style.display 			= "none";
		data.element_ip.style.display 				= "none";
		data.element_mac.style.display 				= "none"; 
		//data.element_deviceNameReal.style.display	= "none";
	}
	
}
// createDeviceData
var deviceDataArray = new Array(); 		// contain all device in here!
var createDeviceData = function(deviceName,ip, priority, mac) {
	var data = new deviceData(deviceName, ip, priority, mac);
	deviceDataArray.push(data);
	return data;
}

//--------------------------------------------------------------
//		Slideshow 
//--------------------------------------------------------------
// setup
var mySlideshow = new Slideshow("slideshow");

//--------------------------------------------------------------
//		Mouse Event (window)
//--------------------------------------------------------------
// Start Drag
function startDrag(dataObject) {

	isDraggingItem  = true;
	dragginItemData = dataObject;
	
	// show priority hitareas
	document.getElementById("prioity_highest_hitarea").style.display = "block";
	document.getElementById("prioity_high_hitarea").style.display    = "block";
	document.getElementById("prioity_medium_hitarea").style.display  = "block";
	
}
// End Drag
function endDrag() {
	isDraggingItem = false;
	
	// hide priority hitareas
	document.getElementById("prioity_highest_hitarea").style.display = "none";
	document.getElementById("prioity_high_hitarea").style.display    = "none";
	document.getElementById("prioity_medium_hitarea").style.display  = "none";
	$("#prioity_highest_bg").stop();
	$("#prioity_highest_bg").stop();
	$("#prioity_highest_bg").stop();
	$("#prioity_highest_bg").animate({opacity:1}, 200);
	$("#prioity_high_bg").animate({opacity:1}, 200);
	$("#prioity_medium_bg").animate({opacity:1}, 200);
	
}
// Mouse Move
document.body.onmousemove = function(e){ //for IE8

    mousex = e.clientX + document.body.scrollLeft;
    mousey = e.clientY + document.body.scrollTop;
	
	if (isDraggingItem) {
		instance.style.top  = mousey + itemMouseOffsetY + "px";
		instance.style.left = mousex + itemMouseOffsetX + "px";
	}
}
window.onmousemove = function(e){
	mousex = e.clientX;
	mousey = e.clientY;
	
	if (isDraggingItem) {
		instance.style.top  = mousey + itemMouseOffsetY + "px";
		instance.style.left = mousex + itemMouseOffsetX + "px";
	}
}
// Mouse Up
function mouseup() {
	if(!isDraggingItem)
		return;

	// check priority
	switch (targetPriority) {
		case "highest":
			if (!priorityGrid_highest.isFull()) {	// check not full
				if(!priorityGrid_highest.existData(dragginItemData)) { 	// check not already in grid (just for safe)
					addDataToPriorityGrid(dragginItemData, priorityGrid_highest, "highest")
					endDrag();
					return;
				}
			}
			break;
			
		case "high":
			if (!priorityGrid_high.isFull()) {	// check not full
				if(!priorityGrid_high.existData(dragginItemData)) { 	// check not already in grid (just for safe)
					addDataToPriorityGrid(dragginItemData, priorityGrid_high, "high")
					endDrag();
					return;
				}
			}
			break;
			
		case "medium":
			if (!priorityGrid_medium.isFull()) {	// check not full
				if(!priorityGrid_medium.existData(dragginItemData)) { 	// check not already in grid (just for safe)
					addDataToPriorityGrid(dragginItemData, priorityGrid_medium, "medium")
					endDrag();
					return;
				}
			}
			break;
		
		// none : show item back
		default:
			endDrag();
			break;
	}
	// instance fly back to original position (animation) //BB
	var originalPos = getElementXY(dragginItemData.element);
	$(instance).animate({top:originalPos.y, left:originalPos.x}, 200, 
		function(){
			// fly back animation completed
			instance.style.display = "none"; 				// hide instance
			dragginItemData.showElement_noAnimation();		// show original item
		});
	
	// End Dragging settings
	endDrag();
}
document.body.onmouseup = function(e) { //for IE8
	mouseup();
}
window.onmouseup = function(e)	{	mouseup();	}

// touch
function checkIfInElement(x, y, element) {
	var pos = getElementXY(element);
	var width  = parseInt(getStyle(element, "width").replace("px", ""));
	var height = parseInt(getStyle(element, "height").replace("px", ""));
	if(x > pos.x && x < pos.x + width && y > pos.y && y < pos.y + height) {
		return true;
	} else {
		return false;
	}
}
function getStyle(oElm, strCssRule){
	var strValue = "";
	if(document.defaultView && document.defaultView.getComputedStyle){
		strValue = document.defaultView.getComputedStyle(oElm, "").getPropertyValue(strCssRule);
	}
	else if(oElm.currentStyle){
		strCssRule = strCssRule.replace(/\-(\w)/g, function (strMatch, p1){
			return p1.toUpperCase();
		});
		strValue = oElm.currentStyle[strCssRule];
	}
	return strValue;
}
	if ( document.addEventListener ) {
		document.addEventListener("touchmove", function(e) {
			mousex = e.changedTouches[0].pageX;
			mousey = e.changedTouches[0].pageY;
			
			if (isDraggingItem) {
				e.preventDefault();
				instance.style.top  = mousey + itemMouseOffsetY + "px";
				instance.style.left = mousex + itemMouseOffsetX + "px";
				
				// area detection
				// medium
				var ishighest = checkIfInElement(mousex, mousey, document.getElementById("prioity_highest_hitarea"));
				if(ishighest) {
					setDraggingTargetPriority("highest");
				} else {
					var ishigh = checkIfInElement(mousex, mousey, document.getElementById("prioity_high_hitarea"));
					if(ishigh) {
						setDraggingTargetPriority("high");
					} else {
						var ismedium = checkIfInElement(mousex, mousey, document.getElementById("prioity_medium_hitarea"));
						if(ismedium) {
							setDraggingTargetPriority("medium");
						} else {
							setDraggingTargetPriority("none");
						}
					}
				}
			}
		});
	}
	if ( document.addEventListener ) {
		document.addEventListener("touchend", function(e)	{	mouseup();	});
	}
//--------------------------------------------------------------
//		Add Data To PriorityGrid
//--------------------------------------------------------------
function addDataToPriorityGrid(data, priorityGrid, priorityName) {
	
	// get next cell Position
	var targetPos = priorityGrid.nextCellPosition();
	
	// instance fly to target
	$(instance).animate({top:targetPos.y, left:targetPos.x}, 100, 
		function(){
			// fly back animation completed
			instance.style.display 	= "none"; 	// hide instance
			
			// add data to cell
			priorityGrid.addData(data);
			
			// set priority to data
			data.setPriority(priorityName);
			
			// hide original
			data.hideElement();
			//save_button_changed();
			//changeFlag = true;
			checkFlag = true;
			GetClickTime();
		});
}
//--------------------------------------------------------------
//		Set Dragging Target Priority (when mouse over priority hitarea)
//--------------------------------------------------------------
function setDraggingTargetPriority(priority) {
	if (isDraggingItem) {
		targetPriority = priority;
		switch(priority) {
			case "highest":
				$("#prioity_highest_bg").stop();
				$("#prioity_high_bg").stop();
				$("#prioity_medium_bg").stop();
				$("#prioity_highest_bg").animate({opacity:1}, 200);
				$("#prioity_high_bg").animate({opacity:0.5}, 200);
				$("#prioity_medium_bg").animate({opacity:0.5}, 200);
				break;
			case "high":
				$("#prioity_highest_bg").stop();
				$("#prioity_high_bg").stop();
				$("#prioity_medium_bg").stop();
				$("#prioity_highest_bg").animate({opacity:0.5}, 200);
				$("#prioity_high_bg").animate({opacity:1}, 200);
				$("#prioity_medium_bg").animate({opacity:0.5}, 200);
				break;
			case "medium":
				$("#prioity_highest_bg").stop();
				$("#prioity_high_bg").stop();
				$("#prioity_medium_bg").stop();
				$("#prioity_highest_bg").animate({opacity:0.5}, 200);
				$("#prioity_high_bg").animate({opacity:0.5}, 200);
				$("#prioity_medium_bg").animate({opacity:1}, 200);
				break;
			case "none":
				$("#prioity_highest_bg").stop();
				$("#prioity_high_bg").stop();
				$("#prioity_medium_bg").stop();
				$("#prioity_highest_bg").animate({opacity:0.5}, 200);
				$("#prioity_high_bg").animate({opacity:0.5}, 200);
				$("#prioity_medium_bg").animate({opacity:0.5}, 200);
				break;
		}
	}
}

//--------------------------------------------------------------
//		InstanceObject (like DeviceData but has a remove button)
//--------------------------------------------------------------
// Instance
var InstanceObject = function() {
	this.deviceName	 = "none";
	this.vendor			= "none";
	this.ip				= "none";
	this.mac			= "none";
	this.deviceNameReal	= "none";
	this.element;
	this.delete_btn;
	this.status;
	this.parent;
	this.deviceData;
	
	// Create Element
	this.element					= document.createElement("div");
	this.element.style.width 		= "188px";
	this.element.style.height 		= "86px";
	this.element.style.fontSize		= "12px";
	this.element.className			= "dataElement";
	this.element.style.cursor		= "default";
	
	// DeviceName
	var deviceName 			= document.createElement("div");
	deviceName.className	= "dataElement_deviceName";
	deviceName.innerHTML 	= this.deviceName;
	
	// Vendor
	//var vendor 				= document.createElement("div");
	//vendor.className		= "dataElement_vendor";
	//vendor.innerHTML		= this.vendor;
	
	// IP
	var ip 					= document.createElement("div");
	ip.className			= "dataElement_ip";
	ip.innerHTML			= this.ip;
	
	// MAC
	var mac					= document.createElement("div");
	mac.className			= "dataElement_mac";
	mac.innerHTML			= this.mac;
	
	// deviceNameReal
	//var deviceNameReal			= document.createElement("div");
	//deviceNameReal.className	= "dataElement_deviceNameReal";
	//deviceNameReal.innerHTML	= this.deviceNameReal;
	
	// Remove Button
	var remove 						= document.createElement("div");
	remove.style.position 			= "absolute";
	remove.style.top 				= "15px";
	remove.style.right 				= "14px";
	remove.style.width 			 	= "13px";
	remove.style.height			 	= "13px";
	remove.style.backgroundImage 	= "url('image/slideshow_closeBtn.png')";
	remove.style.cursor				= "pointer";
	/*remove.onmouseover = function() {
		this.style.backgroundPosition = "top right";
	};
	remove.onmouseout = function() {
		this.style.backgroundPosition = "top left";
	};*/
	
	this.element.appendChild(deviceName);
	//this.element.appendChild(vendor);
	this.element.appendChild(ip);
	this.element.appendChild(mac);
	//this.element.appendChild(deviceNameReal);
	this.element.appendChild(remove);
	
	var base = this;
	//--------------------------------------------------------------
	// Remove Button Event
	remove.onclick = function() {
		base.deviceData.setPriority("none");
		base.deviceData.showElement_backToSlideshow();
		base.parent.removeData(base.deviceData); // remove from prioity grid
		//save_button_changed();
		//changeFlag = true;
		//checkFlag = true;
		GetClickTime();
	}
	
	//--------------------------------------------------------------
	// Functions
	// setDeviceData (for grid update)
	this.setDeviceData = function(data) {
		base.deviceData 		 = data;
		deviceName.innerHTML	 = data.deviceName;
		//vendor.innerHTML		 = data.vendor;
		ip.innerHTML 			 = data.ip;
		mac.innerHTML			 = data.mac;
		//deviceNameReal.innerHTML = data.deviceNameReal;
	}
	// removeDeviceData (for grid update)
	this.removeDeviceData = function() {
		base.deviceData 		 = null;
		deviceName.innerHTML	 = "none";
		//vendor.innerHTML 		 = "none";
		ip.innerHTML 			 = "none";
		mac.innerHTML 			 = "none";
		//deviceNameReal.innerHTML = "none";
	}
	this.show = function() {
		$(this.element).css({ opacity: 1 }); 
		this.element.style.opacity = 1;
		deviceName.style.display  	= "block";
		//vendor.style.display  		= "block";
		ip.style.display  			= "block";
		//mac.style.display  			= "block";
		remove.style.display  		= "block";
	}
	this.hide = function() {
		$(this.element).css({ opacity: 0 }); 
		this.element.style.opacity = 0;
		deviceName.style.display  	= "none";
		//vendor.style.display  		= "none";
		ip.style.display  			= "none";
		//mac.style.display  			= "none";
		remove.style.display 		= "none";
	}
}

//--------------------------------------------------------------
//		Priority Cell (initialize)
//--------------------------------------------------------------
var priorityGrid_highest = new GridPanel(1, 1, "prioity_highest_container");
var highestInstance = new InstanceObject();
priorityGrid_highest.addInstance(highestInstance);

var priorityGrid_high = new GridPanel(2, 1, "prioity_high_container");
for(var i=0; i<2; i++) {
	var _instance = new InstanceObject();
	priorityGrid_high.addInstance(_instance);
}
var priorityGrid_medium = new GridPanel(4, 2, "prioity_medium_container");
for(var i=0; i<8; i++) {
	var _instance = new InstanceObject();
	priorityGrid_medium.addInstance(_instance);


}
//--------------------------------------------------------------
//		Fill Devices
//--------------------------------------------------------------
// addDevice
function addDevice(deviceName,ip, priority, mac) {
//alert("deviceName="+deviceName+",mac="+mac+",ip="+ip);
	// create data
	var data = createDeviceData(deviceName,ip,priority,mac); 
	
	// add data.element to slideshow
	mySlideshow.addItem(data);
	
	// put to priority grid
	switch (priority) {
		case "highest":
			if (!priorityGrid_highest.isFull()) {	// check priority grid is full or not
				priorityGrid_highest.addData(data);
			} else {
				data.setPriority("none"); 		// priority grid is full, set priority to "none".
			}
			break;
		case "high":
			if (!priorityGrid_high.isFull()) {	// check priority grid is full or not
				priorityGrid_high.addData(data);
			} else {
				data.setPriority("none");		 // priority grid is full, set priority to "none".
			}
			break;
		case "medium":
			if (!priorityGrid_medium.isFull()) {	// check priority grid is full or not
				priorityGrid_medium.addData(data);
			} else {
				data.setPriority("none"); 		// priority grid is full, set priority to "none".
			}
			break;
	}
}

//--------------------------------------------------------------
//		Position functions
//--------------------------------------------------------------
function getElementXY(element) {
	var x = 0;
	var y = 0;
	while( element != null ) {
		x += element.offsetLeft;
		y += element.offsetTop;
		element = element.offsetParent;
	}
	return {x:x, y:y};
}
function getMousePosition(e) {
	var _x;
	var _y;
	if (!isIE) {
		_x = e.pageX;
		_y = e.pageY;
	}
	if (isIE) {
		_x = event.clientX + document.body.scrollLeft;
		_y = event.clientY + document.body.scrollTop;
	}
	return true;
}

document.onkeydown = function(e) {
	e = e || window.event; 
	var charCode = e.charCode || e.keyCode;
  	if(charCode == 13) {  // ENTER
	}
};
</script>
</html>
